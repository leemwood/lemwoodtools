# Scripts 目录

本目录包含用于项目开发和 CI/CD 的各种脚本。

## 📁 脚本列表

### 测试结果解析脚本

#### `parse-test-results.sh` (Linux/macOS)
用于解析 JUnit XML 测试结果和 Lint 报告的 Bash 脚本。

**功能**:
- 解析 JUnit XML 测试结果文件
- 统计测试总数、通过数、失败数、跳过数
- 解析 Android Lint XML 结果
- 统计 Lint 错误、警告和信息数量
- 生成 Markdown 格式的测试摘要
- 在 CI/CD 中避免权限问题

**使用方法**:
```bash
# 使用默认路径
./scripts/parse-test-results.sh

# 自定义路径 (修改脚本中的变量)
TEST_RESULTS_DIR="custom/path" ./scripts/parse-test-results.sh
```

#### `parse-test-results.ps1` (Windows)
用于解析测试结果的 PowerShell 脚本，功能与 Bash 版本相同。

**使用方法**:
```powershell
# 使用默认路径
.\scripts\parse-test-results.ps1

# 自定义路径
.\scripts\parse-test-results.ps1 -TestResultsDir "custom\path" -LintResultsDir "custom\lint\path" -OutputFile "custom-summary.md"
```

**参数**:
- `TestResultsDir`: 测试结果目录路径 (默认: `app\build\test-results\testDebugUnitTest`)
- `LintResultsDir`: Lint 结果目录路径 (默认: `app\build\reports`)
- `OutputFile`: 输出文件路径 (默认: `test-summary.md`)

## 🔧 背景说明

### 为什么需要自定义测试结果解析？

在 GitHub Actions 中，我们遇到了使用第三方测试结果发布 Action (`EnricoMi/publish-unit-test-result-action@v2`) 的权限问题：

```
github.GithubException.GithubException: 403 {"message": "Resource not accessible by integration", "documentation_url": "https://docs.github.com/rest/checks/runs#create-a-check-run", "status": "403"}
```

**问题原因**:
- GitHub Actions 的 `GITHUB_TOKEN` 默认权限不足以创建 check runs
- 即使添加了 `checks: write` 权限，某些仓库配置仍可能限制此功能

**解决方案**:
- 创建自定义脚本解析测试结果
- 使用 GitHub Step Summary 显示结果
- 将测试摘要作为 artifact 上传
- 避免依赖需要特殊权限的第三方 Actions

## 📋 前提条件

### 对于测试结果解析脚本

#### Linux/macOS
- `bash` (通常预装)
- `grep`, `sed` (通常预装)

#### Windows
- PowerShell 5.1 或更高版本

## 🚀 使用流程

### 在 CI/CD 中使用 (自动)

脚本在 GitHub Actions 工作流程中自动运行：

```yaml
- name: Generate test summary
  run: |
    chmod +x scripts/parse-test-results.sh
    scripts/parse-test-results.sh
    
- name: Add test summary to job summary
  if: always()
  run: |
    if [ -f "test-summary.md" ]; then
      cat test-summary.md >> $GITHUB_STEP_SUMMARY
    fi
```

### 本地使用

#### Linux/macOS:
```bash
# 运行测试
./gradlew testDebugUnitTest lintDebug

# 解析结果
chmod +x scripts/parse-test-results.sh
./scripts/parse-test-results.sh

# 查看摘要
cat test-summary.md
```

#### Windows:
```powershell
# 运行测试
.\gradlew.bat testDebugUnitTest lintDebug

# 解析结果
.\scripts\parse-test-results.ps1

# 查看摘要
Get-Content test-summary.md
```

## 📊 输出格式

脚本生成的测试摘要包含以下信息：

```markdown
# 🧪 Test Results Summary

Generated on: 2024-01-15 10:30:00

## Unit Tests

- **TEST-com.example.ExampleUnitTest.xml**: 4 tests, 0 failures, 0 skipped

### Summary
- **Total Tests**: 4
- **Passed**: 4
- **Failed**: 0
- **Skipped**: 0
- **Status**: ✅ All tests passed!

## Lint Results

- **lint-results-debug.xml**:
  - Errors: 0
  - Warnings: 2
  - Info: 5

---
*Generated by parse-test-results.sh*
```

## 🔍 故障排除

### 测试结果解析问题

#### 1. 测试结果文件未找到
**症状**: "❌ No test results found" 消息
**解决方案**: 
- 确保已运行测试: `./gradlew testDebugUnitTest`
- 检查路径是否正确: `app/build/test-results/testDebugUnitTest/`
- 验证测试是否成功完成

#### 2. Lint 结果文件未找到
**症状**: "⚠️ No lint result files found" 消息
**解决方案**:
- 确保已运行 Lint: `./gradlew lintDebug`
- 检查 Lint 配置是否正确
- 验证输出格式为 XML: `app/build/reports/lint-results-*.xml`

#### 3. XML 解析错误
**症状**: 脚本执行出错或数据不正确
**解决方案**:
- 检查 XML 文件是否完整和有效
- 验证文件编码 (应为 UTF-8)
- 确保没有语法错误
- 检查 XML 结构是否符合预期格式

#### 4. 权限问题 (Linux/macOS)
**症状**: "Permission denied" 错误
**解决方案**:
```bash
chmod +x scripts/parse-test-results.sh
```

#### 5. PowerShell 执行策略问题 (Windows)
**症状**: "execution of scripts is disabled" 错误
**解决方案**:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

## 🛡️ 安全注意事项

### 脚本安全
- 审查脚本内容后再运行
- 不要在不受信任的环境中运行
- 确保脚本来源可靠
- 定期更新脚本以修复安全问题

### 数据隐私
- 测试结果可能包含敏感信息
- 确保适当的访问控制
- 注意 artifact 的保留期限
- 避免在公共日志中暴露敏感数据

## 📚 相关文档

- [CI/CD 工作流程](../CICD.md)
- [开发指南](../DEVELOPMENT.md)
- [架构指南](../ARCHITECTURE.md)
- [GitHub Actions 文档](https://docs.github.com/en/actions)
- [JUnit XML 格式](https://llg.cubic.org/docs/junit/)
- [Android Lint 文档](https://developer.android.com/studio/write/lint)

## 🆘 获取帮助

如果遇到问题：

1. **检查前提条件**: 确保所有必需工具已安装
2. **查看错误信息**: 仔细阅读错误消息和脚本输出
3. **检查文件路径**: 验证测试结果和 Lint 报告的位置
4. **运行测试**: 确保测试和 Lint 检查已成功完成
5. **参考文档**: 查看相关文档和示例
6. **提交 Issue**: 在 GitHub 仓库中报告问题

## 📝 贡献

欢迎改进这些脚本！请遵循以下准则：

- 保持向后兼容性
- 添加适当的错误处理
- 更新文档
- 测试在不同平台上的兼容性
- 遵循安全最佳实践
- 考虑不同的测试框架和工具

## 🔄 未来改进

计划中的功能：
- [ ] 支持更多测试框架 (Espresso, Robolectric)
- [ ] 集成代码覆盖率报告
- [ ] 支持自定义报告模板
- [ ] 添加性能测试结果解析
- [ ] 支持多模块项目
- [ ] 生成 HTML 格式报告